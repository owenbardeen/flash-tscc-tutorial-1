<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLASH on TSCC Tutorial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --sidebar-width: 280px;
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --border-color: #e1e4e8;
            --bg-color: #ffffff;
            --text-color: #24292e;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--bg-color);
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        #sidebar {
            width: var(--sidebar-width);
            background: #f6f8fa;
            border-right: 1px solid var(--border-color);
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            padding: 20px;
            transition: transform 0.3s ease;
            z-index: 1000;
        }
        
        .sidebar-header {
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .sidebar-header h1 {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 5px;
        }
        
        .sidebar-header p {
            font-size: 0.9rem;
            color: #666;
        }
        
        .nav-section {
            margin-bottom: 25px;
        }
        
        .nav-section h3 {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #666;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }
        
        .nav-links {
            list-style: none;
        }
        
        .nav-links li {
            margin-bottom: 5px;
        }
        
        .nav-links a {
            display: block;
            padding: 8px 12px;
            color: var(--text-color);
            text-decoration: none;
            border-radius: 4px;
            transition: all 0.2s;
        }
        
        .nav-links a:hover {
            background: #e1e4e8;
        }
        
        .nav-links a.active {
            background: var(--secondary-color);
            color: white;
            font-weight: 500;
        }
        
        /* Main Content */
        #content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 40px;
            max-width: 900px;
        }
        
        .markdown-body {
            padding: 40px;
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        /* Page content */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1001;
        }
        
        /* Code styling */
        pre {
            background: #f6f8fa;
            border-radius: 6px;
            padding: 16px;
            overflow-x: auto;
            margin: 20px 0;
            border: 1px solid var(--border-color);
        }
        
        code {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
            font-size: 0.9em;
            background: #f6f8fa;
            padding: 2px 4px;
            border-radius: 3px;
        }
        
        pre code {
            background: transparent;
            padding: 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            #sidebar {
                transform: translateX(-100%);
            }
            
            #sidebar.open {
                transform: translateX(0);
            }
            
            #content {
                margin-left: 0;
                padding: 20px;
            }
            
            .mobile-menu-toggle {
                display: block;
            }
            
            .markdown-body {
                padding: 20px;
            }
        }
        
        /* Footer */
        footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            color: #666;
            font-size: 0.9rem;
        }
        
        .back-to-top {
            display: inline-block;
            margin-top: 10px;
            color: var(--secondary-color);
            text-decoration: none;
            font-size: 0.9rem;
        }
        
        .back-to-top:hover {
            text-decoration: underline;
        }
        
        /* Custom styles for troubleshooting */
        .troubleshooting-item {
            margin-bottom: 25px;
            padding: 15px;
            background: #fff8e1;
            border-radius: 4px;
            border-left: 4px solid #ffa000;
        }
        
        .troubleshooting-item h3 {
            color: #d84315;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <!-- Mobile Menu Button -->
    <button class="mobile-menu-toggle" id="menuToggle">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Sidebar Navigation -->
    <div id="sidebar">
        <div class="sidebar-header">
            <h1>FLASH on TSCC</h1>
            <p>Building & Running FLASH 4.7.1</p>
        </div>
        
        <div class="nav-section">
            <h3>Tutorials</h3>
            <ul class="nav-links">
                <li><a href="#home" class="nav-link active">Home</a></li>
                <li><a href="#environment-setup" class="nav-link">Environment Setup</a></li>
                <li><a href="#building-flash" class="nav-link">Building FLASH</a></li>
                <li><a href="#running-flash" class="nav-link">Running FLASH</a></li>
                <li><a href="#batch-jobs" class="nav-link">Batch Jobs</a></li>
                <li><a href="#troubleshooting" class="nav-link">Troubleshooting</a></li>
                <li><a href="#example-makefile" class="nav-link">Example Makefile</a></li>
            </ul>
        </div>
        
        <div class="nav-section">
            <h3>Resources</h3>
            <ul class="nav-links">
                <li><a href="https://github.com/owenbardeen/flash-tscc-tutorial" target="_blank">
                    <i class="fab fa-github"></i> Source Code
                </a></li>
                <li><a href="https://flash.rochester.edu" target="_blank">
                    <i class="fas fa-external-link-alt"></i> FLASH Website
                </a></li>
                <li><a href="https://www.sdsc.edu/support/user_guides/tscc.html" target="_blank">
                    <i class="fas fa-external-link-alt"></i> TSCC Guide
                </a></li>
            </ul>
        </div>
    </div>
    
    <!-- Main Content -->
    <div id="content">
        <!-- Home Page -->
        <div id="home" class="page active">
            <div class="markdown-body">
                <h1>FLASH on TSCC Tutorial</h1>
                <p class="lead">A step-by-step guide for building and running FLASH 4.7.1 on SDSC's TSCC cluster.</p>
                
                <h2>Prerequisites</h2>
                <ul>
                    <li>TSCC account with access to the cluster</li>
                    <li>Basic knowledge of Linux command line</li>
                    <li>Familiarity with HPC concepts</li>
                    <li>Git installed on your local machine</li>
                </ul>
                
                <h2>Getting Started</h2>
                <p>This tutorial is organized in a logical progression:</p>
                <ol>
                    <li><strong>Environment Setup</strong> - Configure TSCC for FLASH</li>
                    <li><strong>Building FLASH</strong> - Compile FLASH from source</li>
                    <li><strong>Running FLASH</strong> - Execute simulations interactively</li>
                    <li><strong>Batch Jobs</strong> - Submit jobs to TSCC queues</li>
                    <li><strong>Troubleshooting</strong> - Common issues and solutions</li>
                    <li><strong>Example Makefile</strong> - TSCC-optimized build configuration</li>
                </ol>
                
                <div class="alert" style="background: #e3f2fd; padding: 15px; border-radius: 4px; border-left: 4px solid #2196f3; margin: 20px 0;">
                    <strong>Note:</strong> All commands in this tutorial assume you're working on TSCC login nodes.
                </div>
                
                <h2>Quick Start</h2>
                <pre><code># Log into TSCC
ssh username@tscc.sdsc.edu

# Load required modules
module purge
module load shared cpu/0.17.3 gcc/10.2.0-2ml3m2l
module load intel-mpi/2019.10.317-wqrwez3
module load hdf5/1.10.7-rphji2e

# Download FLASH
wget https://flash.rochester.edu/site/flashcode/user_support/flash4.7.1.tar.gz</code></pre>
            </div>
        </div>
        
        <!-- Environment Setup Page -->
        <div id="environment-setup" class="page">
            <div class="markdown-body">
                <h1>Environment Setup (TSCC)</h1>
                
                <p>Before building FLASH, load the correct modules:</p>
                
                <pre><code>module purge
module load shared cpu/0.17.3 gcc/10.2.0-2ml3m2l
module load intel-mpi/2019.10.317-wqrwez3
module load hdf5/1.10.7-rphji2e
module load hypre/2.23.0-vldmtv6</code></pre>
            </div>
        </div>
        
        <!-- Building FLASH Page -->
        <div id="building-flash" class="page">
            <div class="markdown-body">
                <h1>Building FLASH 4.7.1 on TSCC</h1>
                
                <p>Clone FLASH or upload your tarball. </p>

				<pre><code>#Download FLASH 4.7.1 tarball
wget https://flash.rochester.edu/site/flashcode/user_support/flash4.7.1.tar.gz

# Verify the download
ls -lh flash4.7.1.tar.gz

# Unpack the tarball
tar -xzf flash4.7.1.tar.gz</code></pre>
					
				<p>Then create your object folder:</p>
                
                <pre><code>cd FLASH4.7.1
mkdir object
cd object</code></pre>
                
                <p>Copy your site configuration:</p>
                
                <pre><code>cp ../sites/tscc/Makefile.h ../</code></pre>
                
                <p>If the Makefile is not there, see the Makefile section for mine, and copy it into the "FLASH4.7.1" folder.</p>
                
                <p>Get on an interactive session before compiling FLASH.</p>
                
                <pre><code>srun -N 1 -n 4 -t 1:00:00 -p hotel -q hotel -A htl171 --pty bash</code></pre>
                
                <p>This will get you on a compute node with 4 cores for 1 hour. Adjust the parameters as necessary.</p>
                
                <p>Now, compile FLASH.</p>
                
                <pre><code>make -j 4</code></pre>
                
                <h2>Common build errors</h2>
                
                <div class="troubleshooting-item">
                    <h3>❌ Permission denied (e.g., make_bstats)</h3>
                    <p>Fix:</p>
                    <pre><code>chmod +x *
chmod +x ../tools/*</code></pre>
                </div>
                
                <div class="troubleshooting-item">
                    <h3>❌ MPI type mismatch errors</h3>
                    <p>Happen when mixing OpenMPI + system gfortran.<br>
                    This tutorial avoids them by using Intel MPI instead.</p>
                </div>
            </div>
        </div>
        
        <!-- Running FLASH Page -->
        <div id="running-flash" class="page">
            <div class="markdown-body">
                <h1>Running FLASH on TSCC</h1>
                
                <p>Load modules:</p>
                
                <pre><code>module purge
module load shared cpu/0.17.3 gcc/10.2.0-2ml3m2l
module load intel-mpi/2019.10.317-wqrwez3
module load hdf5/1.10.7-rphji2e
module load hypre/2.23.0-vldmtv6</code></pre>
                
                <p>Configure Intel MPI runtime:</p>
                
                <pre><code>export FI_PROVIDER=tcp
export I_MPI_PMI_LIBRARY=/cm/shared/apps/slurm/current/lib64/libpmi2.so
export OMP_NUM_THREADS=1</code></pre>
                
                <p>Run FLASH (example 4 ranks):</p>
                
                <pre><code>srun -n 4 --overlap ./flash4</code></pre>
                
                <h2>If nothing happens when you run srun</h2>
                
                <p>Check you are on a compute node:</p>
                <pre><code>hostname
echo $SLURM_JOB_ID</code></pre>
                
                <p>Check srun exists:</p>
                <pre><code>command -v srun</code></pre>
                
                <p>If missing:</p>
                <pre><code>export PATH=/cm/shared/apps/slurm/current/bin:$PATH</code></pre>
            </div>
        </div>
        
        <!-- Batch Jobs Page -->
        <div id="batch-jobs" class="page">
            <div class="markdown-body">
                <h1>Submitting FLASH Batch Jobs on TSCC</h1>
                
                <p>Create <code>run_flash.sh</code>:</p>
                
                <pre><code>#!/bin/bash
#SBATCH --job-name=flash
#SBATCH --output=flash.out
#SBATCH --nodes=1
#SBATCH --ntasks=16
#SBATCH --partition=hotel
#SBATCH --account=htl171
#SBATCH --time=04:00:00

module purge
module load shared cpu/0.17.3 gcc/10.2.0-2ml3m2l
module load intel-mpi/2019.10.317-wqrwez3
module load hdf5/1.10.7-rphji2e
module load hypre/2.23.0-vldmtv6

export FI_PROVIDER=tcp
export I_MPI_PMI_LIBRARY=/cm/shared/apps/slurm/current/lib64/libpmi2.so
export OMP_NUM_THREADS=1

srun ./flash4</code></pre>
                
                <p>Submit:</p>
                
                <pre><code>sbatch run_flash.sh</code></pre>
            </div>
        </div>
        
        <!-- Troubleshooting Page -->
        <div id="troubleshooting" class="page">
            <div class="markdown-body">
                <h1>Troubleshooting</h1>
                
                <div class="troubleshooting-item">
                    <h3>❌ FLASH hangs on srun</h3>
                    <p>Likely not on a compute node.</p>
                    <pre><code>echo $SLURM_JOB_ID</code></pre>
                    <p>If empty, you are on a login node.<br>
                    Start an interactive job.</p>
                </div>
                
                <div class="troubleshooting-item">
                    <h3>❌ Permission denied (flash4 or make_bstats)</h3>
                    <pre><code>chmod +x flash4
chmod -R +x *</code></pre>
                </div>
                
                <div class="troubleshooting-item">
                    <h3>❌ MPI type mismatch errors</h3>
                    <p>Cause: Using OpenMPI + system gfortran</p>
                    <p>Fix: Use Intel MPI<br>
                    (See Environment Setup)</p>
                </div>
                
                <div class="troubleshooting-item">
                    <h3>❌ srun: command not found</h3>
                    <p>Add Slurm:</p>
                    <pre><code>export PATH=/cm/shared/apps/slurm/current/bin:$PATH</code></pre>
                </div>
                
                <div class="troubleshooting-item">
                    <h3>❌ HDF5/Hypre not found</h3>
                    <p>Ensure modules:</p>
                    <pre><code>module load hdf5/1.10.7-rphji2e
module load hypre/2.23.0-vldmtv6</code></pre>
                </div>
            </div>
        </div>
        
        <!-- Example Makefile Page -->
        <div id="example-makefile" class="page">
            <div class="markdown-body">
                <h1>FLASH Makefile Definitions for TSCC</h1>
                
                <pre><code># FLASH makefile definitions for x86-64 Linux (GNU compilers)
#----------------------------------------------------------------------------
# Set the HDF5/MPI library paths -- these need to be updated for your system
#----------------------------------------------------------------------------
#HDF4_PATH =

MPI_PATH = /cm/shared/apps/spack/0.17.3/cpu/opt/spack/linux-rocky9-cascadelake/gcc-10.2.0/intel-mpi-2019.10.317-wqrwez3nzymbjy6gpdrpoufwuakohd2n/compilers_and_libraries_2020.4.317/linux/mpi/intel64
HDF5_PATH = /cm/shared/apps/spack/0.17.3/cpu/opt/spack/linux-rocky9-cascadelake/gcc-10.2.0/hdf5-1.10.7-rphji2esl5nhlsksljxa5gx2acyrby6f
HYPRE_PATH = /cm/shared/apps/spack/0.17.3/cpu/opt/spack/linux-rocky9-cascadelake/gcc-10.2.0/hypre-2.23.0-vldmtv67ndry7qe57gdxhz7ly6x26axz

#----------------------------------------------------------------------------
# Compiler and linker commands
#
#   Use the MPICH wrappers around the compilers -- these will automatically
#   load the proper libraries and include files.  Version of MPICH prior
#   to 1.2.2 (?) do not recognize .F90 as a valid Fortran file extension.
#   You need to edit mpif90 and add .F90 to the test of filename extensions,
#   or upgrade your MPICH.
#----------------------------------------------------------------------------
FCOMP   = $(MPI_PATH)/bin/mpif90
CCOMP   = $(MPI_PATH)/bin/mpicc
CPPCOMP = $(MPI_PATH)/bin/mpicxx
LINK    = $(MPI_PATH)/bin/mpif90

# pre-processor flag
PP      = -D

#----------------------------------------------------------------------------
# Compilation flags
#
#  Three sets of compilation/linking flags are defined: one for optimized
#  code, one for testing, and one for debugging.  The default is to use the
#  _OPT version.  Specifying -debug to setup will pick the _DEBUG version,
#  these should enable bounds checking.  Specifying _TEST is used for
#  flash_test, and is set for quick code generation, and (sometimes)
#  profiling.  The Makefile generated by setup will assign the generic token
#  (ex. FFLAGS) to the proper set of flags (ex. FFLAGS_OPT).
#----------------------------------------------------------------------------

FFLAGS_OPT = -ggdb -c -O2 -fdefault-real-8 -fdefault-double-8 \
-Wuninitialized

FFLAGS_DEBUG = -ggdb -c -O0 -fdefault-real-8 -fdefault-double-8 \
-pedantic -Wall -Wextra -Waliasing \
-Wsurprising -Wconversion -Wunderflow \
-ffpe-trap=invalid,zero,overflow -fbounds-check \
-fimplicit-none -fstack-protector-all

FFLAGS_TEST = -ggdb -c -fdefault-real-8 -fdefault-double-8 \
-ffree-line-length-none

FFLAGS_HYPRE = -I${HYPRE_PATH}/include
CFLAGS_HYPRE = -I${HYPRE_PATH}/include

FDEFS += -Damr_mpi_real=MPI_DOUBLE_PRECISION -Damr_mpi_integer=MPI_INTEGER -Damr_mpi_logical=MPI_LOGICAL
FFLAGS += -fdefault-real-8 -fdefault-double-8

FDEFS += -DMPI_DOUBLEPRECISION



#The macro _FORTIFY_SOURCE adds some lightweight checks for buffer
#overflows at both compile time and run time (only active at -O1 or higher)
#http://gcc.gnu.org/ml/gcc-patches/2004-09/msg02055.html
CFLAGS_OPT = -ggdb -c -O2 -Wuninitialized -D_FORTIFY_SOURCE=2

CFLAGS_DEBUG = -ggdb -c -O0 -Wno-div-by-zero -Wundef \
-Wconversion -Wstrict-prototypes -Wunreachable-code \
-pedantic -Wall -Wextra -Winit-self -ftree-vrp -Wfloat-equal \
-Wunsafe-loop-optimizations -Wpadded -fstack-protector-all

CFLAGS_TEST = -ggdb -c

# Platform symbol
CDEFINES += -DLINUX

# if we are using HDF5, we need to specify the path to the include files
CFLAGS_HDF5 = -I ${HDF5_PATH}/include -DH5_USE_16_API

CFLAGS_NCMPI = -I$(LIB_NCMPI)/include

#----------------------------------------------------------------------------
# Linker flags
#
#  There is a seperate version of the linker flags for each of the _OPT,
#  _DEBUG, and _TEST cases.
#----------------------------------------------------------------------------

LFLAGS_OPT   = -ggdb -o
LFLAGS_DEBUG = -ggdb -O0 -o
LFLAGS_TEST  = -ggdb -o


#----------------------------------------------------------------------------
# Library specific linking
#
#  If a FLASH module has a 'LIBRARY xxx' line in its Config file, we need to
#  create a macro in this Makefile.h for LIB_xxx, which will be added to the
#  link line when FLASH is built.  This allows us to switch between different
#  (incompatible) libraries.  We also create a _OPT, _DEBUG, and _TEST
#  library macro to add any performance-minded libraries (like fast math),
#  depending on how FLASH was setup.
#----------------------------------------------------------------------------

LIB_OPT   =
LIB_DEBUG =
LIB_TEST  =

#LIB_HDF5  = -L${HDF5_PATH}/lib -lhdf5 /usr/lib64/libz.a
LIB_HDF5  = -L${HDF5_PATH}/lib -Wl,-rpath=${HDF5_PATH}/lib -lhdf5  -DH5_USE_16_API

LIB_PAPI  =
LIB_MATH  =
LIB_MPI   = 

#LIB_NCMPI = -L $(NCMPI_PATH)/lib -lpnetcdf
LIB_MPE   =

LIB_HYPRE = -L${HYPRE_PATH}/lib -Wl,-rpath=${HYPRE_PATH}/lib -lHYPRE

# Uncomment the following line to use electic fence memory debugger.
# Need the following environmental variable (see env.sh):
# export EF_ALLOW_MALLOC_0=1
#CONFIG_LIB = -L/usr/lib64 -lefence

#----------------------------------------------------------------------------
# Additional machine-dependent object files
#
#  Add any machine specific files here -- they will be compiled and linked
#  when FLASH is built.
#----------------------------------------------------------------------------

MACHOBJ =

#----------------------------------------------------------------------------
# Additional commands
#----------------------------------------------------------------------------

MV = mv -f
AR = ar -r
RM = rm -f
CD = cd
RL = ranlib
ECHO = echo

#----------------------------------------------------------------------------
# Fake existence of iso_c_bindings module to prevent unnecessary recompilations.
#---------------------------------------------------------------------------- 
ifeq ($(FLASHBINARY),true)
iso_c_binding.mod :
	touch $@
endif</code></pre>
            </div>
        </div>
        
        <!-- Footer -->
        <footer>
            <p>© 2024 Owen Bardeen. This tutorial is for educational purposes.</p>
            <a href="#" class="back-to-top"><i class="fas fa-arrow-up"></i> Back to top</a>
        </footer>
    </div>

    <script>
        // Navigation
        document.addEventListener('DOMContentLoaded', function() {
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page');
            const menuToggle = document.getElementById('menuToggle');
            const sidebar = document.getElementById('sidebar');
            
            // Handle navigation clicks
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Get target page ID
                    const targetId = this.getAttribute('href').substring(1);
                    
                    // Update active states
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show target page
                    pages.forEach(page => {
                        page.classList.remove('active');
                        if (page.id === targetId) {
                            page.classList.add('active');
                        }
                    });
                    
                    // Close mobile menu on selection
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('open');
                    }
                    
                    // Scroll to top
                    window.scrollTo(0, 0);
                });
            });
            
            // Mobile menu toggle
            menuToggle.addEventListener('click', function() {
                sidebar.classList.toggle('open');
            });
            
            // Close menu when clicking outside on mobile
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768 && 
                    !sidebar.contains(e.target) && 
                    !menuToggle.contains(e.target)) {
                    sidebar.classList.remove('open');
                }
            });
            
            // Back to top button
            document.querySelector('.back-to-top').addEventListener('click', function(e) {
                e.preventDefault();
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
            
            // Handle initial page load from URL hash
            if (window.location.hash) {
                const targetId = window.location.hash.substring(1);
                const targetLink = document.querySelector(`.nav-link[href="#${targetId}"]`);
                if (targetLink) {
                    targetLink.click();
                }
            }
        });
    </script>
</body>
</html>
